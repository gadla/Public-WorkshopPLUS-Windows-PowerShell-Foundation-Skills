<!DOCTYPE html>
<!-- saved from url=(0047)https://labondemand.com/LabProfile/Manual/LABID -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>Local Lab Instructions</title>


    <script src="./Content/jquery-2.1.4.min.js.download" type="text/javascript"></script>
    <script src="./Content/showdown.min.js.download"></script>
    <link rel="stylesheet" type="text/css" href="./Content/prettify.css">
    <script src="./Content/yaml.min.js.download"></script>
    <script src="./Content/LocalizeTo" type="text/javascript"></script>
    <link href="./Content/CloudClient.css" rel="stylesheet" type="text/css">
  
    <style type="text/css">
        body, html {
            font-family: Segoe UI,Tahoma,Verdana,Arial,sans-serif;
            font-size: 14px;
            padding: 0;
            margin: 0;
            background-color: #efefef;
            color: #000;
            height: 100%;
        }

        body {
            overflow:auto;
        }

        #outputWrapper {
            background-color: #efefef;
            min-height:100%;
        }

        .instructionsPreview {
            padding: 20px;
            height: 100%;
        }

        .instructionsPreview .page {
            position:relative;
            display: block !important;
            padding: 15px 20px;
            background-color:#fff;
            page-break-after: always;
            min-height:40px;
        }

        .instructionsPreview .page:not(:first-child) {
            margin-top:20px;
        }

        @media print {
            body, html{
                height:auto;
            }
            
            body {
                -webkit-print-color-adjust: exact;
            }

            div {
                page-break-inside: avoid;
            }

            #outputWrapper {
                background-color: transparent;
            }

            .instructionsPreview {
                padding: 0;
            }

            .instructionsPreview .page:not(:first-child) {
                margin-top: 0px;
            }

        }

        @page {
            margin-left: 1.5cm;
            margin-right: 1.5cm;
            margin-top: 1.5cm;
            margin-bottom: 1.5cm;
        }
    </style>
    <link id="themeStylesheet" href="./Content/Blue.css" rel="stylesheet">

</head>
<body>
    <div id="outputWrapper">
                <div id="instructions" class="instructionsPreview">
    </div>
    <input type="hidden" id="rawContent" value="
[TemplateVersion]:
&#39;1.1&#39;

[LODLabID]:
&#39;39791&#39;

[LODLabNumber]:
&#39;06 FS.Pipeline_Advanced&#39;

[AdminPowerShell]:
```
powershell -NoProfile -command &quot;Start-Process powershell -Verb RunAs&quot;
exit
```

[AdminPowerShellISE]:
```
powershell -NoProfile -command &quot;Start-Process powershell_ise -Verb RunAs&quot;
exit
```

# Welcome student to the module: Understanding the Windows PowerShell Pipeline

In the other modules, the Windows PowerShell **pipeline** has been used in its **simplest** form. In this module, the pipeline&#39;s **potential** will be explored with tasks that have greater depth. This will include **automation** and data **filtering**.

Estimated time to complete this lab: **45 min**

## Objectives

After completing this lab, you will be able to:

- Use the Pipeline variable
- Perform automation with Foreach-Object
- Filter data with Where-Object

===

# Login to Windows 10 and Start the Lab

Login to **win10(wdt** machine with the given credentials. You can find them on the **Resources** pane.

Please login with Username: **+++Power+++** and Password: **+++Pa$$w0rd+++**

After logging in wait until you see the &quot;Lab preparation has been completed&quot; in the action center (This can take up to 2 minutes). If this does not popup you can click in the bottom right of the Vm to open the action center. Begin by opening Windows PowerShell ISE by right clicking on the PowerShell icon and selecting **Run ISE as an Administrator**, or by clicking @[Run ISE as Administrator.][AdminPowerShellISE]{shell visible}

> [!TIP] **Notes about using the lab**
> - It might take a moment to start ISE if you click the above link
> - You can click the **+++Type Text+++** icon to enter the highlighted text at the position of the cursor in the virtual machine. You can also click on the **++Copyto Clipboard++** icon and then paste in at the desired destination.
> - Entering your code in the script pane of the ISE will allow for better troubleshooting if you find errors
> - Remember that the PowerShell ISE will allow you to highlight multiple lines of PowerShell code and run them together by pressing **F8**

===
# Exercise 1: Using The Pipeline Variable

The **pipeline variable** contains the **current** object on the pipeline. This is useful for performing specific actions on **every** object passed along the pipeline.

The **ForEach-Object** cmdlet performs an operation on each item in a **collection** of objects, which often come from the **pipeline**.

This exercise will leverage **Foreach-Object** with the **pipeline variable** to perform some basic **automation** tasks.

## Objectives

After completing this exercise, you will be able to:
- Use the pipeline variable, with multiple names
- Automate basic activities on the pipeline with Foreach-Object
- Use the Begin, Process, and End script blocks

===
# Task 1.1: Pipeline Variable

This task will run through the **basics** of the **pipeline variable** and **Foreach-Object** before using them in the rest of the exercise.

1. [] Open the Windows PowerShell ISE by right clicking on the PowerShell icon and selecting &quot;Run ISE as an Administrator, or by clicking @[Run ISE as Administrator.][AdminPowerShellISE]{shell visible}.

1. [] The following command will take in a **list of numbers** and use the pipeline to perform some basic **multiplication** to each one:

    ```PowerShell-notab
    1,5,10,20 | ForEach-Object {$_ * 5}
    ```
    Notice that **$_** is used to represent the object on the pipeline one at a time.

1. [] The pipeline variable can be **$PSItem** instead of **$_**, though its less common. This code produces the same results:

    ```PowerShell-notab
    1,5,10,20 | ForEach-Object {$PSItem * 5}
    ```

1. [] If the objects on the pipeline come from a cmdlet, the common parameter **-PipelineVariable** can be used to specify a variable name.

    ```PowerShell-notab
    Get-Service -PipelineVariable Service | foreach-object {Write-Host $Service -ForegroundColor Yellow}
    ```

1. [] The Foreach-Object cmdlet has the aliases of **Foreach** and **%**:

    ```PowerShell-notab
    1,5,10,20 | ForEach {$_ * 5}
    ```

    ```PowerShell-notab
    1,5,10,20 | % {$_ * 5}
    ```

1. [] The pipeline variable allows for **accessing** members of the incoming **objects**.

    ```PowerShell-notab
    Get-Service x* | foreach-object {Write-Host $_.DisplayName -ForegroundColor Yellow}
    ```

1. [] When code becomes longer and more difficult to write inline the **script block** used by **Foreach-Object** can be saved into a **variable** ahead of time:

    ```PowerShell-notab
    $SB =  {
        Write-Host $_ -ForegroundColor Yellow
        Write-Host $_.Status -ForegroundColor Cyan
    }
    Get-Service x* | ForEach-Object $SB
    ```

1. [] Create a **pipeline** command that gets **all** the services that *start with x*, **capitalizes** their display names and writes them in **green**. The **DisplayName** property is a **string** and has a **ToUpper()** method.

    <details>
    <summary>Answer</summary>

    ```PowerShell-notab
    Get-Service x* | Foreach {Write-Host $_.DisplayName.ToUpper() -ForegroundColor Green}
    ```
    </details>

The next task will put these skills to use for some real **automation**!
<br />
<br />

===

# Task 1.2: Create Active Directory Users

This task will leverage the pipeline to **automate** creating **multiple** Active Directory (**AD**) users at the same time.

1. [] The **New-ADUser** cmdlet is used to generate active directory users. The only *required* parameter is **-Name**.

    ```PowerShell-notab
    New-ADUser -Name MyNewUser
    ```

    >[!alert] Running this cmdlet with a name that already exists will cause an error! Remember to change the name if running the cmdlet repeatedly.

    >[!Tip] In a real environment **New-ADUser** would likely need **many** more parameters to be useful, but for a test environment this is convenient.

1. [] Try using the pipeline to to create users named *User0*, *User1*, *User2*, and *User3*.
    - `0,1,2,3`  can be used to start the pipeline
    - **Foreach-Object** along with **New-ADUser** can leverage **$_** to generate the users

    <details>
    <summary>Answer</summary>

    ```PowerShell-notab
    0,1,2,3 | Foreach {New-ADUser -Name &quot;User$_&quot;}
    ```
    </details>

1. [] To see the users generated, go to **Start** and launch **Active Directory Users and Computers**. Navigate to the **Users Container** to see the new users that were just created.

    ![Active Directory Users And Computers1](Media/AD-1.png)

1. [] You can also use **PowerShell** to get the list of users.

    +++Get-ADUser -Filter * | Select-Object Name+++

    The new users you created should be the last 4 in the list.

1. [] The numeric range operator, will return a list of numbers. Leverage that and modify the earlier command to make users **4-9**

    Observe the results of +++4..9+++

    <details>
    <summary>Answer</summary>

    ```PowerShell-notab
    4..9 | Foreach {New-ADUser -Name &quot;User$_&quot;}
    ```
    </details>

    > [!Tip] This can be a useful for creating users on a test machine


1. [] To confirm the users were created, you can run the previous **Get-ADUser** cmdlet again or you refresh the **Active Directory Users and Computers** view:

    +++Get-ADUser -Filter * | Select-Object Name+++

    ![Active Directory Users And Computers2](Media/AD-2.png)

<br />
<br />

===

# Task 1.3: Named Blocks

The script block used in a ForEach-Object cmdlet binds to a parameter called **Process**. Along with the Process parameter, ForEach has **Begin** and **End** parameters. These parameters can be used to run script blocks before or after the process block.

1. [] The following code uses the **begin** and **end** parameters to add information before and after the process block. Run the following code to view the results:

    ```PowerShell-notab
    Get-ADUser -Filter &#39;Name -like &quot;user*&quot;&#39; | ForEach-Object -Begin {Write-Host &quot;Attempting to remove users!&quot; -ForegroundColor Green} -Process {Remove-ADUser $_ -WhatIf} -End {Write-Host &quot;Users removed&quot; -ForegroundColor Yellow}
    ```

    > [!Knowledge] Remember, **-WhatIf** returns what would happen **if** the command is run, but it **doesn&#39;t** actually execute the code.

1. [] These script blocks can be saved into **variables** ahead of time, which is helpful when the code becomes longer and harder to **read**. Move the existing code into script blocks and add some **additional lines** to each to use a log file. Try modifying the code to:

    - Use 3 script blocks named **$B**, **$P**, **$E** for the parameters **-Begin**, **-Process**, and **-End** respectively
    - Add to the **Begin** block a line of code **Set-Content** for the file `C:\PShell\Labs\Users.txt` and a value of the current **date**
    - Add to the **Process** block a line of code using **Add-Content** to add the **user** to that file
    - Add to the **End** block a line of code to **open** the file with **notepad**

    <details>
    <summary>Answer</summary>

    ```PowerShell-notab
    $B = {
        Write-Host &quot;Attempting to remove users!&quot; -ForegroundColor Green
        Set-Content C:\PShell\Labs\Users.txt  -Value (Get-Date)
    }
    $P = {
        Remove-ADUser $_ -WhatIf
        Add-Content C:\PShell\Labs\Users.txt  -Value $_
    }

    $E = {
        Write-Host &quot;Users removed&quot; -ForegroundColor Yellow
        Notepad C:\PShell\Labs\users.txt
    }

    Get-ADUser -Filter &#39;Name -like &quot;user*&quot;&#39; | foreach -Begin $B -Process $P -End $E
    ```
    </details>


1. [] The **begin**, **process**, and **end** blocks can also be used within **functions**. Reference the template below to move your previous code into a function.

    ```PowerShell-notab
    Function NameOfFunction
    {
        Begin {}
        Process {}
        End {}
    }
    ```
    > [!Knowledge] When using named blocks in a function, the process block is aware of the **pipeline variable**.

    <details>
    <summary>Answer</summary>

    ```PowerShell-notab
    Function Remove-MyUsers
    {
        Begin
        {
            Write-Host &quot;Attempting to remove users!&quot; -ForegroundColor Green
            Set-Content C:\PShell\Labs\Users.txt  -Value (Get-Date)
        }
        Process
        {
            Remove-ADUser $_ -WhatIf
            Add-Content C:\PShell\Labs\Users.txt  -Value $_
        }
        End
        {
            Write-Host &quot;Users removed&quot; -ForegroundColor Yellow
            Notepad C:\PShell\Labs\users.txt
        }
    }

    Get-ADUser -Filter &#39;Name -like &quot;user*&quot;&#39; | Remove-MyUsers
    ```
    </details>


<br />
<br />

===

# Exercise 2: Filtering Data

Many cmdlets use **parameters** to **filter** for specific data. For example, **Get-Service** has a **-Name** parameter to find services with a specific name or by using wildcards.

When a cmdlet does **not** have a parameter to filter data itself, **Where-Object** can be used to **filter** any data using **custom** code. Where-Object is a powerful cmdlet that is used *frequently*.

## Objectives

After completing this exercise, you will be able to:

- Understand Boolean values
- Use comparison and logical operators
- Filter objects with Where-Object

===

# Task 2.1: Boolean basics

**Where-Object** will take in a **list** of objects, generally from the **pipeline**, and will run a script block against **each** one. If the script block results in a **True** value, the object is **kept** in the results.

**True** and **False** values are known as **booleans** or bools. **All** decision making for automation uses these **boolean** values.

1. [] Open the Windows PowerShell ISE by right clicking on the PowerShell icon and selecting &quot;Run ISE as an Administrator, or by clicking @[Run ISE as Administrator.][AdminPowerShellISE]{shell visible}.

1. [] To see the **basics** of **Where-Object**, run the following commands. Notice that when False is returned, none of the objects are kept in the results.

    +++Get-Service | Where-Object {$True}+++

    +++Get-Service | Where-Object {$False}+++

1. [] Services returned by Get-Service have **boolean** properties, which can be seen with Get-Member. Notice the **CanPauseAndContinue** property.

    +++Get-Service | Get-Member -MemberType Properties+++

1. [] Run the **Where-Object** command again, but this time use the pipeline variable in the script block to find only the services that can **pause and continue**.

    <details>
    <summary>Answer</summary>

    +++Get-Service | Where-Object {$_.CanPauseAndContinue}+++
    </details>

<br />
<br />

===

# Task 2.2: Comparison Operators

Most of the time, **filtering** will require a little more work. **Comparing** values to one another allows for this. This is what allows for asking important **questions** about the data. These are known as **comparison operators**, some of the most common ones are:

| Question | Operator |
|:--- |:---|
| Is X **equal** to Y? | -eq |
| Is X **greater** than Y? | -gt |
| Is X **less** than Y? | -lt |
| Is X greater than **or** equal to Y? | -ge |
| Is X less than **or** equal to Y? | -le |
| Is X **equal** to Y? Using **wildcards** | -like |

<br/>

> [!Knowledge] By **default**, comparison operators are **case insensitive**, but prepending a &quot;c&quot; will **force** case sensitivity. There are some additional comparisons as well.

1. [] All of these **operators** come **in between** the values they&#39;re **comparing**. Experiment with the following code to observe the behavior:

    ```PowerShell-notab-nocopy
    5 -gt 1
    5 -gt 10
    5 -eq 5
    5 -lt 5
    5 -le 5
    ```

1. [] Based on the previous example, try to write code for these questions:

    | Question | Code |
    |:--- |:---|
    | Is &quot;STATUS&quot; equal to &quot;status&quot;? | <details><summary>Answer</summary>`&quot;STATUS&quot; -eq &quot;status&quot;`</details> |
    | Is 10 less than 25? |<details><summary>Answer</summary>`10 -lt 25`</details>|
    | Is &quot;cube&quot; equal to &quot;cu*&quot;? |<details><summary>Answer</summary>`&quot;cube&quot; -eq &quot;cu*&quot;`</details>|
    | Is &quot;cube&quot; like &quot;cu*&quot;? |<details><summary>Answer</summary>`&quot;cube&quot; -like &quot;cu*&quot;`</details>|

1. [] Often, one or more of the values are unknown and come from a **property** of an object during automation. Use **Get-Service** and create a variable named **$Service** that holds the service named **AudioSrv**. Then try to write code answering the questions in the table:

    +++$Service = Get-Service Audiosrv+++

    | Question | Code |
    |:--- |:---|
    | Is the **Status** property equal to &quot;Running&quot;? | <details><summary>Answer</summary>`$Service.Status -eq &quot;Running&quot;`</details> |
    | Is the **StartType** property equal to &quot;Automatic&quot;? |<details><summary>Answer</summary>`$Service.StartType -eq &quot;Automatic&quot;`</details>|
    | Is the **Status** property equal to &quot;Stopped&quot;?|<details><summary>Answer</summary>`$Service.Status -eq &quot;Stopped&quot;`</details>|

1. [] Leverage this knowledge and write a **pipeline** command that gets **every** service and then uses **Where-Object** and the **pipeline variable** to show only the services that have a **StartType** of **disabled**:

    <details>
    <summary>All disabled services</summary>

    ```PowerShell-notab
    Get-Service | Where-Object {$_.StartType -eq &quot;Disabled&quot;}
    ```
    </details>

1. [] Write a **pipeline** command that gets **every** service and then uses **Where-Object** to show **only** the services that have a **status** of **running**:

    <details>
    <summary>All running services</summary>

    ```PowerShell-notab
    Get-Service | Where-Object {$_.Status -eq &quot;Running&quot;}
    ```
    </details>

<br />
<br />

===

# Task 2.3: Logical Operators

Often, **more** than one question needs to be **asked**. A number might need to be **both** greater than 0, but **also** less than 10. A service might need to be automatic, but **also** running.

**Logical** operators are used to join **multiple** booleans together, usually coming from **comparisons**.

| Question | Operator |
|:--- |:---|
| Are **both** X and Y **True**? | **-and** |
| Is **either** X or Y **True**? | **-or** |
| Is **either** X or Y True, **and** the other **False**? | **-xor** |
| What is the **opposite** of X? | **-not** or **!**|

1. [] Just like **comparison** operators, **logical** operators come **in between** the values they&#39;re **comparing**. It is often best to wrap **individual** comparisons in **parenthesis** to stay organized. Experiment with the following code to observe the behavior:

    ```PowerShell-notab-nocopy
    (5 -gt 1) -and (5 -gt 10)
    (5 -gt 1) -and (25 -gt 10)

    (5 -gt 1) -or (5 -gt 10)

    (5 -gt 1) -xor (5 -gt 10)
    (5 -gt 1) -xor (25 -gt 10)
    ```

1. [] Create a variable named $Text with the value &quot;Hello World&quot; then try write code to answer the following questions. Strings have **StartsWith()** and **EndsWith()** methods. **The input to these methods is case sensitive**.

    +++$Text = &quot;Hello World&quot;+++

    | Question | Code |
    |:--- |:---|
    | Does $Text start with &quot;H&quot; **and** end with &quot;World&quot;? |<details><summary>Answer</summary>`$Text.StartsWith(&quot;H&quot;) -and $Text.EndsWith(&quot;World&quot;)`</details> |
    | Does $Text start with &quot;H&quot; **and** end with &quot;Help&quot;? |<details><summary>Answer</summary>`$Text.StartsWith(&quot;H&quot;) -and $Text.EndsWith(&quot;Help&quot;)`</details>|
    | Does $Text start with &quot;H&quot; **or** end with &quot;Help&quot;?  |<details><summary>Answer</summary>`$Text.StartsWith(&quot;H&quot;) -or $Text.EndsWith(&quot;Help&quot;)`</details>|
    | Does $Text start with &quot;H&quot; **or** end with &quot;ld&quot;, **but not both**.  |<details><summary>Answer</summary>`$Text.StartsWith(&quot;H&quot;) -xor $Text.EndsWith(&quot;ld&quot;)`</details>|

1. [] Write a pipeline command that gets **every** service and uses Where-Object to show **only** the services that have **both** a *status* of *running* and have a display name that **starts** with **&quot;W&quot;**. The &quot;W&quot; must be **uppercase**.

    <details>
    <summary>Answer</summary>

    ```PowerShell-notab
    Get-Service | Where {$_.Status -eq &quot;Running&quot; -and $_.DisplayName.StartsWith(&quot;W&quot;)}
    ```
    </details>

    > [!Tip] **Where** and **?** are aliases for Where-Object

1. [] The default display for services isn&#39;t ideal, but Where-Object **doesn&#39;t** have to be the end of the pipeline. Take the previous command, send it to a **Format-Table** and look at just the *DisplayName* and *Status* properties.

    <details>
    <summary>Answer</summary>

    ```PowerShell-notab
    Get-Service | Where {$_.Status -eq &quot;Running&quot; -and $_.DisplayName.StartsWith(&quot;W&quot;)} | Format-Table DisplayName, Status
    ```
    </details>


<br />
<br />

===

# Self test (Optional part of the course)

## Self test information

The following self test is an optional part of this course and can be used to evaluate if your knowledge of the subject matter is sufficient. You can use this self test to re-evaluate your knowledge after taking the course or test your knowledge before you take / retake the course.

This self test uses 10 questions and or exercises. To get a fair result you should complete this self test using your knowledge only and not using any internet search engines.

##  Self test duration

Although the self test is not timed this test should be completed in approximately 15 minutes.

To start the self test continue to the next page.

===

# Self test Questions and Exercises

1. <Removed>
___

2. <Removed>
___

3. <Removed>
___

4. <Removed>
___

5. <Removed>
___

6. <Removed>
___

7. <Removed>
___

8. <Removed>
___

9. <Removed>
___

10. <Removed>
___

===
# Congratulations!

You have successfully completed this module. To mark the lab as complete, click **End**.



">
    <input type="hidden" id="activities" value="[]">
    <input type="hidden" id="replacementTokens" value="[{&quot;Token&quot;:&quot;@lab.LabProfile.Id&quot;,&quot;Replacement&quot;:&quot;38671&quot;},{&quot;Token&quot;:&quot;@lab.CtrlAltDelete&quot;,&quot;Replacement&quot;:&quot;&lt;a href=&#39;#&#39; class=&#39;ctrlAltDeleteLink&#39;&gt;Ctrl+Alt+Delete&lt;/a&gt;&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(WIN10).SelectLink&quot;,&quot;Replacement&quot;:&quot;&lt;a href=&#39;#&#39; class=&#39;selectMachineLink&#39; data-data=&#39;63124&#39;&gt;WIN10&lt;/a&gt;&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(WIN10).Username&quot;,&quot;Replacement&quot;:&quot;Power&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(WIN10).Password&quot;,&quot;Replacement&quot;:&quot;Pa$$$$w0rd&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(MS).SelectLink&quot;,&quot;Replacement&quot;:&quot;&lt;a href=&#39;#&#39; class=&#39;selectMachineLink&#39; data-data=&#39;54597&#39;&gt;MS&lt;/a&gt;&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(MS).Username&quot;,&quot;Replacement&quot;:&quot;Power&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(MS).Password&quot;,&quot;Replacement&quot;:&quot;Pa$$$$w0rd&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(DC).SelectLink&quot;,&quot;Replacement&quot;:&quot;&lt;a href=&#39;#&#39; class=&#39;selectMachineLink&#39; data-data=&#39;54598&#39;&gt;DC&lt;/a&gt;&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(DC).Username&quot;,&quot;Replacement&quot;:&quot;Administrator&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(DC).Password&quot;,&quot;Replacement&quot;:&quot;Pa$$$$w0rd&quot;},{&quot;Token&quot;:&quot;@lab.OpticalMedia(5638).LoadLink&quot;,&quot;Replacement&quot;:&quot;&lt;a href=&#39;#&#39; class=&#39;loadMediaLink opticalMedia&#39; data-data=&#39;5638&#39;&gt;Introduction to Commands - 0050&lt;/a&gt;&quot;},{&quot;Token&quot;:&quot;@lab.LabInstance.Id&quot;,&quot;Replacement&quot;:&quot;[ID]&quot;},{&quot;Token&quot;:&quot;@lab.LabInstance.GlobalId&quot;,&quot;Replacement&quot;:&quot;[lodID]&quot;},{&quot;Token&quot;:&quot;@lab.LabInstance.StartDate&quot;,&quot;Replacement&quot;:&quot;20190108&quot;},{&quot;Token&quot;:&quot;@lab.User.Id&quot;,&quot;Replacement&quot;:&quot;[USERID]&quot;},{&quot;Token&quot;:&quot;@lab.User.FirstName&quot;,&quot;Replacement&quot;:&quot;[FIRSTNAME]&quot;},{&quot;Token&quot;:&quot;@lab.User.LastName&quot;,&quot;Replacement&quot;:&quot;[LASTNAME]&quot;},{&quot;Token&quot;:&quot;@lab.User.Email&quot;,&quot;Replacement&quot;:&quot;[EMAIL]&quot;},{&quot;Token&quot;:&quot;@lab.User.ExternalId&quot;,&quot;Replacement&quot;:&quot;[EXTERNALID]&quot;},{&quot;Token&quot;:&quot;@lab.Tag&quot;,&quot;Replacement&quot;:&quot;[TAG]&quot;}]">

    <textarea id="copyInput" value="" style="position: absolute; left:-10000px; top:-10000px; "></textarea>

    <script type="text/javascript"> 
    
        String.prototype.replaceAll = function(search, replacement) {
            var target = this;
            return target.replace(new RegExp(search, 'g'), replacement);
        };

        var childWindows = [];

        function showClickFeedbackMessage(text, x, y, duration) {
            var $message = $("<div class='clickFeedbackMessage noselect'>" + text + "</div>");
            $message.appendTo($("body")).hide();
            $message.css({ left: x, top: y });
            $message.fadeIn("fast");
            window.setTimeout(function () {
                $message.fadeOut("fast", function () { $message.remove(); });
            }, duration);
        }

        function copyableClicked(element) {
            //only copy if we are clicking, not if we have used the mouse to select the text manually.
            var selectedText;
            if (window.getSelection) {
                selectedText = window.getSelection().toString();
            } else if (document.selection && document.selection.type !== "Control") {
                selectedText = document.selection.createRange().text;
            }
            if (selectedText) { return };

            var $element = $(element);
            var text = $element.text();
            $("#copyInput").val(text).select();
            var offset = $element.offset();
            var x = offset.left;
            var y = offset.top - 40;
            try {
                var successful = document.execCommand("copy");
                if (successful) {
                    showClickFeedbackMessage("Copied to clipboard", x, y, 2000);
                } else {
                    showClickFeedbackMessage("Copying was unsuccessful", x, y, 2000);
                }
            } catch (err) {
                showClickFeedbackMessage("Copying was unsuccessful", x, y, 2000);
                console.log("Unable to copy. " + err);
            }
        }

        function setupKnowledgeExpanders() {
            $(".knowledge").each(function () {
                var knowledge = this;
                var $knowledge = $(this);
                var $moreKnowledge = $knowledge.next();
                if ($moreKnowledge.is(".moreKnowledge")) {
                    var maxHeight = 100;
                    var leeway = 100;
                    var diff = knowledge.scrollHeight - maxHeight;
                    if (diff < leeway) {
                        $knowledge.removeClass("collapsed");
                        $moreKnowledge.find("a").hide();
                    } else {
                        //this is tall content, let's show the 'more' link
                        $moreKnowledge.find("a").show();
                        $knowledge.addClass("collapsed");
                    }
                }
            });
        }

        var variables = {};

        function processVariables() {
            $("span.variable").each(function () {
                var $this = $(this);
                var name = $this.attr("data-name");
                if (name in variables) {
                    $this.html(variables[name]);
                } else {
                    $this.text("<" + name + ">");
                }
            });
            $("input.variableTextBox").each(function () {
                var $this = $(this);
                var name = $this.attr("data-name");
                if (name in variables) {
                    $this.val(variables[name]);
                } else {
                    $this.val("");
                }
            });
            $("code").each(function () {
                var originalHtml = this.originalHtml ? this.originalHtml : this.innerHTML;
                var newHtml = originalHtml;
                for (var name in variables) {
                    var val = variables[name];
                    var regex = new RegExp('<span class="nocode">&lt;' + name + '&gt;</span>', 'g');
                    newHtml = newHtml.replace(regex, val);
                }
                if (originalHtml != newHtml || originalHtml != this.innerHTML) {
                    this.originalHtml = originalHtml;
                    this.innerHTML = newHtml;
                }
            });
        }
        
        window.onload = function () {

            var rawContent = document.getElementById("rawContent").value;
            var contentRoot = "./Content/"
            var activitiesString = document.getElementById("activities").value;
            var activities = (activitiesString == null || activitiesString.length == 0) ? [] : JSON.parse(activitiesString);
            var replacementTokensString = document.getElementById("replacementTokens").value;
            var replacementTokens = (replacementTokensString == null || replacementTokensString.length == 0) ? [] : JSON.parse(replacementTokensString);
            instructionsProcessor.process(rawContent, "instructions", false, contentRoot, replacementTokens,
                function ($page) {
                    setupKnowledgeExpanders();
                },
                activities
            );
            $(".page").each(function () {
                var $page = $(this);
                if ($page.find("iframe.externalManual").length > 0) {
                    $page.css("padding", 0);
                }
            });

            $("body").on("click", ".moreKnowledgeLink", function (e) {
                e.preventDefault();
                var $link = $(this);
                var $knowledge = $link.parent().prev();
                if ($knowledge.hasClass("expanded")) {
                    $knowledge.removeClass("expanded");
                    $link.text("more...");
                } else {
                    $knowledge.addClass("expanded");
                    $link.text("...less");
                }
            }).on("click", ".copyable, code:not(.nocopy)", function (e) {
                copyableClicked(this);
            }).on("click", ".dialogLink", function (e) {
                e.preventDefault();
                e.stopImmediatePropagation();
                var $dialogLink = $(this);
                var title = $dialogLink.attr("title");
                var target = $dialogLink.attr("data-target");
                if (target) {
                    var $hiddenDialog = $("blockquote.referenceContent[data-id='" + target + "']");
                    if ($hiddenDialog.length === 0) {
                        alert('CONTENT ERROR: Unable to find a reference content "' + target + '"');
                    } else {
                        showDialog({title:title, content: $hiddenDialog.html() });
                    }
                }
                else {
                    showDialog({title:title, url: $dialogLink.attr("href"), isInstructions: $dialogLink.hasClass("instructions") });
                }
            }).on("click", ".videoLink, video", function (e) {
                e.preventDefault();
                var videoUrl = $(this).hasClass("videoLink") ? this.href : this.src;
                var url = "./Content/" + videoUrl.split('Content/').pop().replace(/\#(.*?)$/, '').replace(/\?(.*?)$/, '')
                if (this.title) {
                    
                }
                var videoWindow = window.open(url, "videoWindow", "menubar=no,location=no,resizable=yes,scrollbars=yes,status=no");
                childWindows.push(videoWindow);
                try {
                    videoWindow.focus();
                } catch (e) {

                }
            }).on("click", ".imageLink, img", function (e) {
                var $this = $(this);
                if ($this.parent().is("a")) return;
                e.preventDefault();
                e.stopImmediatePropagation();
                var imgUrl = $this.hasClass("imageLink") ? this.href : this.src;
                var url = "./Content/" + imgUrl.split('Content/').pop().replace(/\#(.*?)$/, '').replace(/\?(.*?)$/, '')
                if (this.title) {
                    
                }
                var imageWindow = window.open(url, "imageWindow", "menubar=no,location=no,resizable=yes,scrollbars=yes,status=no");
                childWindows.push(imageWindow);
                try {
                    imageWindow.focus();
                } catch (e) {

                }
            }).on("click", ".tipLink", function (e) {
                e.preventDefault();
                var $tiplink = $(this);
                var $hiddenTip = $tiplink.next();
                var offset = $(this).offset();
                var x = offset.left;
                var y = offset.top + 25;
                showClickFeedbackMessage($hiddenTip.html().replaceAll('<code title="Copy to clipboard" class="prettyprint">','<code title="Copy to clipboard" style="background-color:#8888;" class="prettyprint">').replaceAll("class",'style="background-color:#8888;" class'), x, y, 5000);
            }).on("change", ".variableTextBox", function () {
                var $textBox = $(this);
                var name = $textBox.attr("data-name");
                var val = $textBox.val();
                if (val == null || val.length == 0) {
                    if (name in variables) {
                        delete variables[name];
                    }
                } else {
                    variables[name] = val;
                }
                processVariables();
            });;

            $(window).resize(function () {
                setupKnowledgeExpanders();
            }).unload(function () {
                closeAllChildWindows();
            });

            function closeAllChildWindows() {
                for (var i = 0; i < childWindows.length; i++) {
                    try {
                        childWindows[i].close();
                    } catch (e) {
                    }
                }
                childWindows = [];
            }

            function showDialog(options) {
                if (!options) return;
                var $dialog = $("#modalDialog");
                var isUpdatedContent = false;
                if ($dialog.length > 0) {
                    $dialog.find(".dialogContent").html("");
                    $dialog.find(".dialogButtons").html("");
                    isUpdatedContent = true;
                } else {
                    var $dialog = $('<div id="modalDialog" class="dialog"><div class="dialogMask"></div><div class="dialogBox"><div class="dialogCloseButton"></div><div class="dialogTitle"></div><div class="dialogContent"></div><div class="dialogButtons"></div></div></div>');
                }
                var $dialogBox = $dialog.find(".dialogBox");
                var close = function () {
                    var h = $dialogBox.outerHeight();
                    var offset = $dialogBox.offset();
                    $dialogBox.css("marginTop", 0).animate({ marginTop: -h - offset.top }, 300);
                    $dialog.delay(200).fadeOut("fast", function () { $dialog.remove(); });
                }
                $dialog.find(".dialogCloseButton").click(close);

                if (options.title) {
                    $dialog.find(".dialogTitle").html(options.title).show();
                } else {
                    $dialog.find(".dialogTitle").hide();
                    $dialog.addClass("noTitle");
                }
                if (options.content) {
                    $dialog.find(".dialogContent").removeClass("noScroll").append(options.content);
                } else if (options.url) {
                    var urlLower = options.url.toLowerCase();
                    if (urlLower.indexOf(".mp4") !== -1) {
                        $dialog.find(".dialogContent").removeClass("noScroll").append('<video src="' + options.url + '" controls autoplay></video>');
                        var $video = $("#contentDialogVideo");
                        try {
                            $video[0].play();
                        } catch (e) {
                            //
                        }
                    } else if (urlLower.indexOf(".png") !== -1 || urlLower.indexOf(".jpg") !== -1 || urlLower.indexOf(".jpeg") !== -1 || urlLower.indexOf(".gif") !== -1) {
                        $dialog.find(".dialogContent").removeClass("noScroll").append('<img src="' + options.url + '" controls></iframe>');
                    } else if (options.isInstructions || urlLower.indexOf(".md") !== -1) {
                        $dialog.find(".dialogContent").removeClass("noScroll").append('<div id="instructionsDialog"></div>');
                        window.setTimeout(function () {
                            instructionsProcessor.processUrl(options.url, "instructionsDialog");
                            if (options.url.indexOf("#") >= 0) {
                                window.setTimeout(function () {
                                    var hash = options.url.substr(options.url.indexOf("#"));
                                    var $element = $("#instructionsDialog " + hash);
                                    if ($element.length > 0) {
                                        $dialog.find(".dialogContent").scrollTop($element.position().top);
                                    }
                                }, 400); //leave time for the content to layout... the dialog takes 400ms to animate anyway, which should be sufficient.
                            }
                        }, 1);
                    } else {
                        $dialog.find(".dialogContent").addClass("noScroll").append('<iframe id="contentDialogIFrame" src="' + options.url + '" style="width:100%;height:100%;border:none;" allowfullscreen></iframe>');
                    }
                } else {
                    $dialog.find(".dialogContent").hide();
                }
                if (options.buttons && options.buttons.length > 0) {
                    $dialog.addClass("hasButtons");
                    var $dialogButtons = $dialog.find(".dialogButtons");
                    var numButtons = options.buttons.length;
                    for (var i = 0; i < numButtons; i++) {
                        var button = options.buttons[i];
                        var $button = $("<input type='button' value='" + button.text + "' />");
                        if (button.click) {
                            $button.click(button.click);
                        }
                        if (button.primary) {
                            $button.addClass("primary");
                        }
                        if (button.closeDialog) {
                            $button.click(close);
                        }
                        $dialogButtons.append($button);
                    }
                }
                if (!isUpdatedContent) {
                    $("body").append($dialog);
                    $dialog.hide().fadeIn("fast", function () {
                        if (options.open) {
                            options.open();
                        }
                    });
                    var h = $dialogBox.outerHeight();
                    var offset = $dialogBox.offset();
                    $dialogBox.css("marginTop", -h - offset.top).animate({ marginTop: 0 }, 400);
                }
                return {
                    close: close
                };
            }

        }

        function getScrollTop() {
            return document.body.scrollTop;
        }

    </script>


</body>
</html>
